---
title: Установка miniPBX на компьютер
description: 
published: true
date: 2022-03-22T12:08:53.238Z
tags: 
editor: markdown
dateCreated: 2022-03-15T12:18:37.759Z
---

# Базовая установка
## Общие сведения
АТС miniPBX работает под управлением ОС GNU/Linux. Для её работы требуется аппаратный ключ-токен. Без него программа работает в демо-режиме.

### <a id="demo_mode"></a>Особенности демо-режима (без ключа-токена)
- Одна внешняя GSM-линия
- Один одновременный звонок
- Автообзвон можно выполнить только 1 раз
- [API](https://api.sprecord.cloud/docs#/) недоступен

## Подготовка системы
Перед установкой АТС необходимо убедиться в наличии и в случае необходимости установить следующие компоненты:
- docker
- usb-modeswitch
- netstat

В Ubuntu/Debian/Astra это можно сделать командой:
```
apt update && apt install -y \
	docker.io \
	usb-modeswitch \
	net-tools
```
В CentOS/Fedora/RedHat:
```
yum install -y \
	docker \
	usb_modeswitch \
	net-tools
```

> Программа modemmanager (ModemManager) должна быть отключена либо удалена во избежение конфликтов доступа к USB-модемам.
{.is-warning}

## Установка программы
1. Скачайте установочные [файлы](https://poladis.ru/minipbx-pc/stable/pbx.php), распакуйте архив и перейдите в директорию с распакованными файлами. Сделать это можно последовательностью команд:
```
wget -c https://poladis.ru/minipbx-pc/stable/pbx.php -O - | tar -xz && cd minipbx
```
2. При необходимости выполните дополнительные настройки (см. раздел «[Расширенная настройка](#advanced_setting)»). Вы можете пропустить этот шаг, программа будет установлена с настройками по умолчанию.

3. При наличии ключ-токена, вставьте его в любой доступный USB-порт.
> Ключ-токен не должен извлекаться из компьютера во время работы АТС. При отсутствии ключа-токена АТС перейдёт в [демо-режим](#demo_mode).
{.is-warning}

4. Запустите процесс установки командой
```
./install
```
После успешной установки АТС будет автоматически запущена. При этом через несколько секунд после запуска должен загореться индикатор на ключе-токене. Если индикатор не загорелся в течение 30 секунд, перейдите в раздел «Устраненние неполадок».

Когда индикатор загорится, перейдите в браузер и откройте в нем страницу по адресу: `http://localhost`

Возможно, потребуется еще некоторое время, чтобы АТС запустилась и веб-интерфейс стал доступен.

## Управление работой АТС
### Control {.tabset}
#### Запуск
```
minipbx-start
```
#### Остановка
```
minipbx-stop
```
#### Перезапуск
```
minipbx-restart
```
#### Статус
```
minipbx-status
```

## Обновление АТС
```
minipbx-update
```
> При наличии обновлений работа АТС будет остановлена. После завершения обновления она будет вновь запущена.
{.is-warning}

## Удаление программы
```
minipbx-uninstall
```
> Все созданные во время работы АТС данные удалены не будут. Если вы ходите удалить их тоже, выполните команды (для настроек по умолчанию):
{.is-info}
```
rm -rf /etc/minipbx.cfg /usr/share/minipbx && \
docker image rm cr.yandex/crp9f1mct0nssd2k2cic/minipbx-pc-base
```

# <a id="advanced_setting"></a>Расширенная настройка
После скачивания и распаковки архива вы можете произвести тонкую настройку процесса установки. Для этого необходимо отредактировать файл `dist/minipbx.cfg`.

> После установки файл конфигурации будет скопирован в /etc/minipbx.cfg
{.is-info}

| Переменная | Назначение | По умолчанию |
| :--- | :--- | :--- |
| `TARGET` | Директория* для установки файлов программы. В ней по умолчанию будет содержаться рабочая директория workdir, которая хранит различные генерируемые в процессе работы АТС данные | /usr/share/minipbx |
| `ADD_PATH` | Дополнительный путь для поиска исполняемых программ (в дополнение к системной переменной PATH) | Не установлено |
| `TIMEZONE` | Часовой пояс в формате tzdata. Если не установлен, АТС попытается определить его автоматически | Не установлено |
| `NET_INTERFACE` | Название сетевого интерфейса. Если не установлен, АТС попытается определить его автоматически. Если будет найдено несколько, будет выбран первый из них. В настоящий момент влияет только на выбор интерфейса, с которого будет снят дамп. | Не установлено |
| `PATH_MISC` | Директория* для хранения дампов и других данных. Размер может достигать нескольких ГБ. | workdir/misc |
| `PATH_LOGS` | Директория* для хранения логов. Размер может достигать нескольких сотен МБ. | workdir/logs |
| `PATH_CONFIGS` | Директория* для хранения конфигурации АТС. Размер может достигать нескольких сотен МБ. | workdir/configs |
| `PATH_SOUNDS` | Директория* для хранения загруженных аудиофайлов. Размер может достигать нескольких сотен МБ. | workdir/sounds |
| `PATH_KEYS` | Директория* для хранения файлов лицензии. Размер может достигать нескольких КБ. | workdir/keys |
| `PATH_RECORDS` | Директория* для хранения файлов лицензии. Размер может достигать нескольких десятков ГБ. | workdir/records |
| `PATH_REALTIME` | Директория* для хранения временных и др. файлов. Размер может достигать нескольких десятков МБ. | workdir/realtime |
| `SERVICES_CTRL` | Система управления службами. Возможные значения: systemd и no. Выбрав значение no, можно отказаться от использования systemd и управлять запуском АТС вручную | systemd |
| `DIALOUT` | Идентификатор группы USB-модемов | Не установлено |

> *После установки при редактивании настроек в /etc/minipbx.cfg, связанных с путями, перенос соответствующих каталогов по новому пути производиться не будет, это нужно будет выполнить самостоятельно до запуска (перезапуска) АТС.
{.is-info}

Значения переменных `PATH_MISC`, `PATH_LOGS`, `PATH_DB`, `PATH_CONFIGS`, `PATH_SOUNDS`, `PATH_KEYS`, `PATH_RECORDS`, `PATH_REALTIME` могут быть заданы как относительно TARGET, так и указаны абсолютными значениями.

Каждая строка файла конфигурации, содержащая переменную и ее значение имеет строгий формат: `VARIABLE=VALUE`, где `VARIABLE` — название переменной, а `VALUE` — ее значение. Не допускается наличие пробельных символов (пробел, табуляция) между `VARIABLE` и `=`, а также между `=` и `VALUE`. Если `VALUE` содержит пробельные символы, то всё `VALUE` следует заключить в двойные кавычки. Если в файле будет присутствовать несколько строк с одним и тем же названием переменной, то будет использовано последнее из них. После символа `#` допустим комментарий.

# Firewall
Для корректной работы minipbx может потребоваться настройка либо полное отключение firewall'а. 

## Настройка
> Представленные ниже конфигурации актуальны только для настроек по умолчанию в minipbx. Например, если вы изменили [номер SIP-порта](/minipbx/user_manual/description/sip_settings#port_number) или [протокол](/minipbx/user_manual/description/sip_settings#tcp_enable) (с UDP на TCP), то необходимо будет изменить конфигурации firewall'ов.

### Firewall {.tabset}

#### UFW

Создайте текстовый файл `/etc/ufw/applications.d/minipbx` со следующим содержимым
```
[minipbx]
title=miniPBX
description=miniPBX
ports=80/tcp|9000/tcp|5060/udp|10000:20000/udp
```
Далее выполните команду:
```
ufw allow minipbx
```

#### FirewallD
Создание нового сервиса
```
firewall-cmd --permanent --new-service=minipbx 
```
Добавление портов в сервис
```
firewall-cmd --permanent --service=minipbx \
	--add-port=80/tcp \
	--add-port=9000/tcp \
	--add-port=5060/udp \	
	--add-port=10000-20000/udp
```  
Перезагрузка
```
firewall-cmd --reload && \
firewall-cmd --permanent --add-service=minipbx && \
firewall-cmd --reload 
```

## Отключение
### Firewall {.tabset}
#### UFW
```
ufw disable
```
#### FirewallD
```
systemctl disable --now firewalld
```
